<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="4-level page table of x86_64."><title>project1::page_table - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Regular-46f98efaafac5295.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Regular-018c141bf0843ffd.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/FiraSans-Medium-8f9a781e4970d388.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceSerif4-Bold-a2c9cd1067f8b328.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../static.files/SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2"><link rel="stylesheet" href="../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../static.files/rustdoc-0ef3deca4ed45ad8.css" id="mainThemeStyle"><link rel="stylesheet" id="themeStyle" href="../../static.files/light-f501212b8b071243.css"><link rel="stylesheet" disabled href="../../static.files/dark-e92fc12c34ff89d3.css"><link rel="stylesheet" disabled href="../../static.files/ayu-a0090c8b1ced384f.css"><script src="../../static.files/storage-3891ce972e3a2bf8.js"></script><script defer src="../../static.files/main-bfa4087bf2db080e.js"></script><noscript><link rel="stylesheet" href="../../static.files/noscript-13285aec31fa243e.css"></noscript><link rel="alternate icon" type="image/png" href="../../static.files/favicon-16x16-8b506e7a72182f1c.png"><link rel="alternate icon" type="image/png" href="../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="logo-container" href="../../project1/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2></h2></nav><nav class="sidebar"><a class="logo-container" href="../../project1/index.html"><img class="rust-logo" src="../../static.files/rust-logo-151179464ae7ed46.svg" alt="logo"></a><h2 class="location"><a href="#">Module page_table</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#enums">Enums</a></li></ul></section></div></nav><main><div class="width-limiter"><nav class="sub"><form class="search-form"><span></span><input class="search-input" name="search" aria-label="Run search in the documentation" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><div id="help-button" title="help" tabindex="-1"><a href="../../help.html">?</a></div><div id="settings-menu" tabindex="-1"><a href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../static.files/wheel-7b819b6101059cd0.svg"></a></div></form></nav><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../index.html">project1</a>::<wbr><a class="mod" href="#">page_table</a><button id="copy-path" title="Copy item path to clipboard"><img src="../../static.files/clipboard-7571035ce49a181d.svg" width="19" height="18" alt="Copy item path"></button></h1><span class="out-of-band"><a class="srclink" href="../../src/project1/page_table.rs.html#1-611">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>4-level page table of x86_64.</p>
<p>Implement x86_64’s 4-level page table scheme.
More specifically, implement <a href="struct.PageTable.html#method.map" title="PageTable::map"><code>PageTable::map</code></a>, <a href="struct.PageTable.html#method.unmap" title="PageTable::unmap"><code>PageTable::unmap</code></a> and <a href="struct.PageTable.html#method.walk" title="PageTable::walk"><code>PageTable::walk</code></a>.</p>
<h3 id="background"><a href="#background">Background</a></h3><h4 id="memory-protection"><a href="#memory-protection">Memory Protection</a></h4>
<p>One of the main role of operating system is resource abstraction.
From now, you build an abstraction for CPU resources.
The other important resource of computer system is memory.</p>
<p>Each process has their own memory. Each process’s memory must not visible from others.
For example, your web browser should not be able to access the memory of your music player.
To do so, the harware introduce the memory protection mechanism to isolate the memory between processes.</p>
<h4 id="virtual-memory"><a href="#virtual-memory">Virtual Memory</a></h4>
<p>The concept of virtual memory is to abstract memory addresses from the underlying physical storage device.
Instead of accessing the storage device directly, it is authenticated and translated through the memory management unit (MMU).
To distinguish the two types of addresses, the pre-translation address is called a virtual address, and the post-translation address is called a physical address.
One important difference between these two types of addresses is that the physical addresses are unique and always refer to the same memory location.
For virtual addresses, two different virtual addresses can refer to the same physical address. The same virtual address can also refer to different physical addresses.</p>
<h4 id="paging"><a href="#paging">Paging</a></h4>
<p>Paging is a technique that divides physical and virtual memory space into small chunks of the same size. Each lump is called a page, and it’s typically 4096 bytes.
The mapping of physical and virtual memory spaces is managed through the page table.
Typically, the currently active page table is managed through a register on a special CPU (e.g. cr3 in x86_64).</p>
<h3 id="page-table"><a href="#page-table">Page table</a></h3>
<p>For each memory access, the CPU translates the virtual memory address to the physical memory address through the page table.
Because it is inefficient to check the page table for each conversion, the CPU stores the previous results in a cache called Translation Lookaside Buffer (TLB).
The page table is also used to set attributes such as access permissions (e.g. read/write) for each page.
Note that attributes of all levels are <strong>AND</strong>ed.</p>
<h3 id="paging-in-x86_64"><a href="#paging-in-x86_64">Paging in x86_64</a></h3>
<p>x86_64 uses a 4096-byte page and a 4-level page table. Each table has 4096 bytes, the same size as the page, and an entry of table is 8 bytes.
Therefore, the 4-level page table can cover up to 48bit physical address.</p>
<p>The index for each level can be calculated from the virtual memory address:</p>

<div class="example-wrap"><pre class="rust rust-example-rendered"><code><span class="number">63          48 47            39 38            30 29            21 20         12 11         0
</span>+-------------+----------------+----------------+----------------+-------------+------------+
| Sign Extend |    Page-Map    | Page-Directory | Page-directory |  Page-Table |    Page    |
|             | Level-<span class="number">4 </span>Offset |    Pointer     |     Offset     |   Offset    |   Offset   |
+-------------+----------------+----------------+----------------+-------------+------------+
              |                |                |                |             |            |
              +------- <span class="number">9 </span>------+------- <span class="number">9 </span>------+------- <span class="number">9 </span>------+----- <span class="number">9 </span>-----+---- <span class="number">12 </span>----+
                                          Virtual Address</code></pre></div>
<p>A page must be page-aligned, that is, start on a virtual address evenly divisible by the page size.
Thus, the last 12 bits of a 64-bit virtual address is the page offset (or just offset). The upper bits are used to indicate the index in the page table.</p>
<p>Each process has an independent set of user pages, which are those pages below the kernel base.
The set of kernel pages, on the other hand, is global, and thus remain in the same position regardless of what thread or process is running.
The kernel may access both user and kernel pages, but a user process may access only its own user pages.</p>
<p>KeOS provides several useful functions for working with virtual addresses and physical addresses.
See <a href="../../keos/addressing/struct.Pa.html"><code>Pa</code></a> and <a href="../../keos/addressing/struct.Va.html"><code>Va</code></a> for details.</p>
<h4 id="translation-lookaside-buffer"><a href="#translation-lookaside-buffer">Translation lookaside Buffer</a></h4>
<p>The TLB entry is not updated when the content of page table is changed.
Therefore, the kernel must invalidates the updated entry from the TLB by calling a special CPU instruction.
In x86_64, <code>invlpg</code> removes the entry according to the specified entry.
You can use <a href="struct.TLBInvalidate.html"><code>TLBInvalidate</code></a> to invalidate the TLB entry.
Note that TLB is fully flushed when <code>cr3</code> is reloaded.</p>
</div></details><h2 id="structs" class="small-section-header"><a href="#structs">Structs</a></h2><div class="item-table"><div class="item-row"><div class="item-left"><a class="struct" href="struct.PageTable.html" title="struct project1::page_table::PageTable">PageTable</a></div><div class="item-right docblock-short">4-level page table of x86_64.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.Pde.html" title="struct project1::page_table::Pde">Pde</a></div><div class="item-right docblock-short">Page directory entry.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.PdeFlags.html" title="struct project1::page_table::PdeFlags">PdeFlags</a></div><div class="item-right docblock-short">Flags for pde.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.Pdpe.html" title="struct project1::page_table::Pdpe">Pdpe</a></div><div class="item-right docblock-short">Page directory pointer table entry.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.PdpeFlags.html" title="struct project1::page_table::PdpeFlags">PdpeFlags</a></div><div class="item-right docblock-short">Flags for pdpe.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.Permission.html" title="struct project1::page_table::Permission">Permission</a></div><div class="item-right docblock-short">Possible memory permissions.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.Pml4e.html" title="struct project1::page_table::Pml4e">Pml4e</a></div><div class="item-right docblock-short">Page Map Level 4 entry.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.Pml4eFlags.html" title="struct project1::page_table::Pml4eFlags">Pml4eFlags</a></div><div class="item-right docblock-short">Flags for pml4e.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.Pte.html" title="struct project1::page_table::Pte">Pte</a></div><div class="item-right docblock-short">Page table entry.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.PteFlags.html" title="struct project1::page_table::PteFlags">PteFlags</a></div><div class="item-right docblock-short">Flags for pte.</div></div><div class="item-row"><div class="item-left"><a class="struct" href="struct.TLBInvalidate.html" title="struct project1::page_table::TLBInvalidate">TLBInvalidate</a></div><div class="item-right docblock-short">Struct for invalidating the tlb entry.</div></div></div><h2 id="enums" class="small-section-header"><a href="#enums">Enums</a></h2><div class="item-table"><div class="item-row"><div class="item-left"><a class="enum" href="enum.PageTableMappingError.html" title="enum project1::page_table::PageTableMappingError">PageTableMappingError</a></div><div class="item-right docblock-short">A list specifying categories of page table operation error.</div></div></div></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-static-root-path="../../static.files/" data-current-crate="project1" data-themes="" data-resource-suffix="" data-rustdoc-version="1.69.0-nightly (585f3eef2 2023-02-11)" data-search-js="search-28136cea55c34037.js" data-settings-js="settings-f0c5c39777a9a2f6.js" data-settings-css="settings-0bcba95ff279c1db.css" ></div></body></html>